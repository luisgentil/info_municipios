<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<meta charset="utf-8">
<meta version="0.0.1">
<title>[BORRAR]función comprobarEnWiki - action = query</title>
<!--link rel="stylesheet" type="text/css" href="css/mapas.css" /-->

<script type="text/javascript">
// Comprobar si existe una página concreta en Wikipedia
function comprobarEnWiki(pueblo) {
  var numero = 0;
  var xmlhttp = new XMLHttpRequest();
  // cuando obtiene una respuesta ejecuta la function interna
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState==4 && xmlhttp.status==200) {
      var respuesta = JSON.parse(xmlhttp.responseText);
      if (respuesta.error) {
        console.log(respuesta.error);
        document.getElementById("init_LatLong").innerHTML = respuesta.error.code; 
        document.getElementById("info_plus").innerHTML = ""; }
      else {
        console.log(respuesta);
      var numero = respuesta.parse.pageid;
      document.getElementById("init_LatLong").innerHTML = numero; //respuesta.parse.pageid;
      var comienzo = respuesta.parse.text["*"].indexOf('<p><b>'); // \n<p><b> es la mejor opción, <b> mejor que <p>, en algunos casos había errores, con esto se localiza dónde comienza el párrafo de presentación
      var terminac_destacado = respuesta.parse.text["*"].indexOf('<h2>') - 1;
      var presentación =respuesta.parse.text["*"].substring(comienzo, terminac_destacado);
      var terminac_normal = presentación.indexOf('</p>') ;// con <h2> , toda la presentación // con indexOf('h2') localiza dónde comienza el apartado "Índice", que comienza con un h2 que debe ser el primero de la página. '-1' para evitar signo '<'.
      var primer_parrafo =presentación.substring(0, terminac_normal);
      
       // el texto de presentación COMPLETO es el contenido entre el primer indexOf y el segundo indexOf; el PRIMER PÁRRAFO es el texto hasta </p>, salvo en artículos destacados, que tienen introducción y lían la cosa. Una solución más general: seleccionar toda la introducción, mediante comienzo-terminac_destacado, que da el mismo resultado en todos los casos (pueblos y destacados); sobre esta selección, hacer una segunda selección buscando </p>, que ahora sí será mayor que comienzo en todos los casos. El primer párrafo será siempre entre comienzo y terminac_normal.  
      document.getElementById("info_plus").innerHTML = primer_parrafo;
          }
      // secciones y links ////
      var link = 'href=\"https://es.wikipedia.org/wiki/'+pueblo +'#';
      for (x in respuesta.parse.sections){
        var sectionLink = link + respuesta.parse.sections[x].line;
        sectionLink = sectionLink.replace(/\s/g,"_");
        console.log(sectionLink);
        console.log('<a '+ sectionLink +"\"" + ">" + respuesta.parse.sections[x].line + "</a>" + " - ");
        document.getElementById("info_plus").innerHTML += '<a '+ sectionLink +"\"" + ">" + respuesta.parse.sections[x].line + "</a>" + " - "}; //así se crea una lista de secciones con links --- 

     }
    }
  var consulta = "https://es.wikipedia.org/w/api.php?action=parse&page="+ pueblo +"&format=json&origin=*";
  xmlhttp.open ("GET", consulta, true); // ahora sí funciona con true // originalmente 'true', al ponerlo false SÍ funciona como quiero. Pero me da un mensaje de función deprecated, 
  xmlhttp.send();
  numero = document.getElementById("init_LatLong").innerHTML; //  console.log(numero);
  return numero;
}


//}

function cambiar() {
	var valor =  comprobarEnWiki("Sevilla"); // antes de terminar el cálculo sigue ejecutando, ¿y con while?
  //	if (valor == undefined) {
	 console.log("valor:" + valor);
	 document.getElementById("info_plus").innerHTML = valor; 
  //comprobarEnWiki(document.getElementById('submit').value)
	//console.log(document.getElementById("init_LatLong").innerHTML);
  //	}
  }

</script>
</head>

<body>
<h5>Ahora usa el pueblo = "Sevilla"</h5>

<input id="submit" value="Sevilla">
<input id="click" type="button" onclick = comprobarEnWiki(document.getElementById('submit').value) value="On">

<br>
<input id="otro" type="button" onclick = cambiar() value="otro">

<p>Al hacer click debería devolver el nº wiki del pueblo</p>

<div id="init_LatLong">inicial</div>

<div id="info_plus">al pulsar el botón "otro" debe cambiar al nº de wiki. hay un div hidden, para cargar el texto y después seleccionar sólo el primer párrafo.</div>

<div id="texto" hidden>texto</div>

</body>
</html>